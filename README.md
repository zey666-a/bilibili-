# B站字幕自动开启插件

一个专为B站（bilibili.com）设计的浏览器插件，可以自动为视频开启字幕，支持中英文字幕智能选择。版本为2.0，因为第一版代码找不到了，为了防止后面开发又找不到代码故上传

## 功能特性

### 🎯 核心功能
- **自动开启字幕**：打开B站视频时自动启用字幕
- **智能语言选择**：支持中文(ai-zh)和英文(ai-en)字幕
- **实时切换**：支持在插件界面实时切换字幕语言
- **智能回退**：当首选语言不可用时自动选择备选语言

### 🔧 设置选项
- **插件开关**：可随时启用/禁用插件功能
- **默认语言**：设置首选的字幕语言（默认中文）
- **实时状态**：显示当前页面和插件状态

### 📱 适配场景
- **普通视频**：支持/video/路径下的视频
- **番剧视频**：支持/bangumi/play/路径下的番剧
- **分集切换**：自动处理选集切换（无需刷新页面）
- **页面刷新**：刷新页面后自动重新应用设置

## 安装方法

### 开发者模式安装
1. 下载或克隆此项目到本地
2. 打开Edge浏览器，进入 `edge://extensions/`
3. 开启"开发人员模式"
4. 点击"加载解压缩的扩展"
5. 选择项目文件夹
6. 插件安装完成

### 图标文件
需要在 `icons/` 目录下添加以下图标文件：
- `icon16.png` (16x16)

## 使用说明

### 基本使用
1. 安装插件后，访问任意B站视频页面
2. 插件会自动检测并开启字幕
3. 点击插件图标可打开设置面板
4. 在设置面板中调整字幕偏好

### 设置说明

#### 插件开关
- **启用插件**：控制插件是否自动处理字幕
- 关闭后不会自动开启字幕，但可手动操作

#### 字幕语言设置
- **中文 (AI)**：选择ai-zh作为默认字幕（默认选项）
- **英文 (AI)**：选择ai-en作为默认字幕
- 如果视频没有选定语言，会自动回退到可用语言

### 状态指示
- **绿色圆点**：插件正常工作，已检测到B站页面
- **灰色圆点**：插件已禁用或当前不是B站页面
- **红色圆点**：插件遇到错误

## 技术实现

### 核心机制
- **URL监听**：监测B站页面URL变化（单页应用特性）
- **DOM观察**：监听视频元素和字幕菜单的动态加载
- **异步处理**：处理B站字幕的异步加载机制
- **智能重试**：多次尝试确保字幕正确加载

### 字幕检测
```javascript
// 获取可用字幕语言
function getAvailableLanguages() {
  const container = document.querySelector('.bpx-player-ctrl-subtitle-major-content');
  const items = container.querySelectorAll('[data-lan]');
  return Array.from(items).map(el => ({
    code: el.getAttribute('data-lan'),
    name: el.innerText.trim()
  }));
}

// 选择字幕语言
function selectLanguage(lanCode) {
  const targetItem = document.querySelector(`[data-lan="${lanCode}"]`);
  if (targetItem) {
    targetItem.click();
    return true;
  }
  return false;
}
```

### 智能语言选择
- **首选语言**：优先选择用户设置的默认语言
- **智能回退**：如果首选语言不可用，自动选择备选语言
- **防止关闭**：选择字幕后不立即关闭菜单，确保设置生效

## 文件结构

```
├── manifest.json          # 插件配置文件
├── popup/                 # 弹窗界面
│   ├── popup.html        # 弹窗HTML
│   ├── popup.js          # 弹窗逻辑
│   └── popup.css         # 弹窗样式
├── content_scripts/       # 内容脚本
│   ├── content.js        # 主要功能逻辑
│   └── style.css         # 注入样式
├── scripts/              # 后台脚本
│   └── background.js     # 后台服务
├── icons/                # 图标文件
│   └── icon-info.txt     # 图标说明
└── README.md             # 说明文档
```

## 兼容性

### 浏览器支持
- ✅ Microsoft Edge (Chromium)
- ✅ Google Chrome
- ✅ 其他基于Chromium的浏览器

### B站页面支持
- ✅ 普通视频页面 (`/video/`)
- ✅ 番剧页面 (`/bangumi/play/`)
- ✅ 分集切换
- ✅ 页面刷新

### 字幕类型支持
- ✅ AI生成字幕 (ai-zh, ai-en)
- ✅ 用户上传字幕
- ✅ 官方字幕

## 常见问题

### Q: 插件没有自动开启字幕？
A: 请检查：
1. 插件是否已启用
2. 当前视频是否有可用字幕
3. 刷新页面重试

### Q: 双语字幕无法开启？
A: 此版本已移除双语字幕功能，专注于单语言字幕的稳定性和可靠性。

### Q: 切换选集后字幕消失？
A: 插件会自动检测选集切换并重新应用字幕设置，如果没有生效请稍等几秒或手动刷新。

## 开发说明

### 本地开发
1. 克隆项目：`git clone [项目地址]`
2. 在Edge中加载解压缩的扩展
3. 修改代码后点击"重新加载"按钮

### 调试方法
- **弹窗调试**：右键插件图标 → 检查弹出内容
- **内容脚本调试**：在B站页面按F12，查看Console
- **后台脚本调试**：在扩展管理页面点击"检查视图"

## 更新日志

### v2.0.0 (2024-01-13)
- ✨ 初始版本发布
- ✨ 支持自动开启B站视频字幕
- ✨ 支持中英文字幕选择
- ✨ 完整的设置界面
- ✨ 智能语言回退机制
- ✨ 修复字幕自动关闭问题
- ✨ 默认语言设置为中文(ai-zh)

## 许可证

MIT License - 详见 LICENSE 文件

## 贡献

欢迎提交Issue和Pull Request来改进这个插件！

---

**注意**：此插件仅用于改善B站观看体验，请遵守B站的使用条款。